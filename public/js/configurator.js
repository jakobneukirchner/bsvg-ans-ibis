// BSVG Konfigurator - FUNKTIONIERT JETZT
let cycles=[],lines=[],stops=[],audioLibrary=[],currentTab='cycles';document.addEventListener('DOMContentLoaded',()=>{showStartDialog()});function showStartDialog(){showModal('<div style="text-align:center;padding:40px;"><h2>Konfigurator starten</h2><p style="margin:20px 0;">Wähle eine Option:</p><div style="display:flex;gap:12px;justify-content:center;"><button onclick="startEmpty()" class="btn btn-secondary" style="padding:15px 30px;">Leer starten</button><button onclick="loadExisting()" class="btn btn-primary" style="padding:15px 30px;">Aktuelle laden</button></div></div>')}async function loadExisting(){closeModal();const base=CONFIG.FILESERVER_URL;try{const[l,s,c,a]=await Promise.all([fetch(base+'/lines.json').then(r=>r.json()),fetch(base+'/stops.json').then(r=>r.json()),fetch(base+'/cycles.json').then(r=>r.json()),fetch(base+'/audio-library.json').then(r=>r.json())]);lines=l.lines||[];stops=s.stops||[];cycles=c.cycles||[];audioLibrary=a.audioFiles||[];alert('Geladen: '+lines.length+' Linien, '+stops.length+' Stops, '+cycles.length+' Cycles')}catch(e){alert('Fehler: '+e.message);lines=[];stops=[];cycles=[];audioLibrary=[]}init()}function startEmpty(){closeModal();cycles=[];lines=[];stops=[];audioLibrary=[];alert('Leere Konfiguration');init()}function init(){setupTabs();setupButtons();renderCurrentTab()}function setupTabs(){document.querySelectorAll('.tab').forEach(t=>{t.addEventListener('click',()=>{currentTab=t.dataset.tab;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('tab-'+currentTab).classList.add('active');renderCurrentTab()})})}function setupButtons(){const a=document.getElementById('addCycleBtn'),b=document.getElementById('addLineBtn'),c=document.getElementById('addStopBtn'),d=document.getElementById('exportBtn');if(a)a.addEventListener('click',()=>openCycleModal());if(b)b.addEventListener('click',()=>openLineModal());if(c)c.addEventListener('click',()=>openStopModal());if(d)d.addEventListener('click',exportData)}function renderCurrentTab(){if(currentTab==='cycles')renderCycles();if(currentTab==='lines')renderLines();if(currentTab==='stops')renderStops()}function renderCycles(){const c=document.getElementById('cyclesList');if(!c)return;if(cycles.length===0){c.innerHTML='<div class="empty-state">Keine Umläufe. Klicke auf + um einen zu erstellen.</div>';return}c.innerHTML=cycles.map(x=>{const l=lines.find(z=>z.id===x.lineId);return`<div class="item-card"><div class="item-info"><h3>${x.cycleId} - ${x.name}</h3><p><b>Linie:</b> ${l?l.name:x.lineId} | <b>Typ:</b> ${x.type}</p></div><div class="item-actions"><button onclick="editCycle('${x.cycleId}')" class="btn btn-secondary">Edit</button><button onclick="deleteCycle('${x.cycleId}')" class="btn btn-secondary">Delete</button></div></div>`}).join('')}function openCycleModal(id=null){const c=id?cycles.find(x=>x.cycleId===id):null;const ao=audioLibrary.filter(a=>a.tags&&a.tags.includes('destination')).map(a=>`<option value="${a.id}" ${c&&c.destinationAudioId===a.id?'selected':''}>${a.id}</option>`).join('');const lo=lines.map(l=>`<option value="${l.id}" ${c&&c.lineId===l.id?'selected':''}>${l.name}</option>`).join('');showModal(`<span class="close" onclick="closeModal()">×</span><h2>${c?'Edit':'New'}</h2><label>ID:</label><input id="cycleId" value="${c?c.cycleId:''}" ${c?'readonly':''} placeholder="3_10"/><label>Line:</label><select id="lineId">${lo||'<option>Keine Linien</option>'}</select><label>Type:</label><select id="type"><option value="regular" ${c&&c.type==='regular'?'selected':''}>Regular</option><option value="diversion" ${c&&c.type==='diversion'?'selected':''}>Diversion</option></select><label>Name:</label><input id="name" value="${c?c.name:''}"/><label>Direction:</label><input id="direction" value="${c?c.direction:''}"/><label>Audio:</label><select id="destinationAudioId"><option value="">--</option>${ao}</select><label>Via:</label><input id="viaStops" value="${c&&c.viaStops?c.viaStops.join(','):''}"/><label>Priority:</label><input type="number" id="priority" value="${c?c.priority:1}" min="1" max="10"/><div class="modal-buttons"><button onclick="closeModal()" class="btn btn-secondary">Cancel</button><button onclick="saveCycle(${!!c})" class="btn btn-primary">Save</button></div>`)}function saveCycle(isEdit){const id=document.getElementById('cycleId').value.trim();if(!id){alert('ID fehlt');return}const data={cycleId:id,paddedId:id.split('_')[1]?id.split('_')[1].padStart(2,'0'):'01',lineId:document.getElementById('lineId').value,type:document.getElementById('type').value,name:document.getElementById('name').value.trim(),direction:document.getElementById('direction').value.trim(),destinationAudioId:document.getElementById('destinationAudioId').value,viaStops:document.getElementById('viaStops').value.trim().split(',').map(s=>s.trim()).filter(Boolean),route:[],specialAnnouncements:[],priority:parseInt(document.getElementById('priority').value)||1};if(isEdit){const idx=cycles.findIndex(c=>c.cycleId===id);if(idx!==-1)cycles[idx]=data}else{cycles.push(data)}closeModal();renderCycles();alert('Gespeichert!')}function deleteCycle(id){if(confirm('Delete?')){cycles=cycles.filter(c=>c.cycleId!==id);renderCycles()}}function editCycle(id){openCycleModal(id)}function renderLines(){const c=document.getElementById('linesList');if(!c)return;if(lines.length===0){c.innerHTML='<div class="empty-state">Keine Linien. Klicke auf + um eine zu erstellen.</div>';return}c.innerHTML=lines.map(l=>`<div class="item-card"><div class="item-info"><h3 style="color:${l.color}">${l.name}</h3><p><b>ID:</b> ${l.id}</p></div><div class="item-actions"><button onclick="editLine('${l.id}')" class="btn btn-secondary">Edit</button><button onclick="deleteLine('${l.id}')" class="btn btn-secondary">Delete</button></div></div>`).join('')}function openLineModal(id=null){const l=id?lines.find(x=>x.id===id):null;const ao=audioLibrary.filter(a=>a.tags&&a.tags.includes('line')).map(a=>`<option value="${a.id}" ${l&&l.audioId===a.id?'selected':''}>${a.id}</option>`).join('');showModal(`<span class="close" onclick="closeModal()">×</span><h2>${l?'Edit':'New'} Line</h2><label>ID:</label><input id="lineId" value="${l?l.id:''}" ${l?'readonly':''}/><label>Padded:</label><input id="linePaddedId" value="${l?l.paddedId:''}" maxlength="3"/><label>Name:</label><input id="lineName" value="${l?l.name:''}"/><label>Display:</label><input id="displayName" value="${l?l.displayName:''}"/><label>Color:</label><input type="color" id="lineColor" value="${l?l.color:'#0066B3'}"/><label>Text:</label><input type="color" id="textColor" value="${l?l.textColor:'#FFF'}"/><label>Type:</label><select id="lineType"><option value="tram" ${l&&l.type==='tram'?'selected':''}>Tram</option><option value="bus" ${l&&l.type==='bus'?'selected':''}>Bus</option></select><label>Operator:</label><input id="operator" value="${l?l.operator:'BSVG'}"/><label>Audio:</label><select id="lineAudioId"><option value="">--</option>${ao}</select><div class="modal-buttons"><button onclick="closeModal()" class="btn btn-secondary">Cancel</button><button onclick="saveLine(${!!l})" class="btn btn-primary">Save</button></div>`)}function saveLine(isEdit){const id=document.getElementById('lineId').value.trim();if(!id){alert('ID fehlt');return}const data={id,paddedId:document.getElementById('linePaddedId').value.trim()||id.padStart(3,'0'),name:document.getElementById('lineName').value.trim(),displayName:document.getElementById('displayName').value.trim(),color:document.getElementById('lineColor').value,textColor:document.getElementById('textColor').value,type:document.getElementById('lineType').value,operator:document.getElementById('operator').value.trim(),audioId:document.getElementById('lineAudioId').value};if(isEdit){const idx=lines.findIndex(l=>l.id===id);if(idx!==-1)lines[idx]=data}else{lines.push(data)}closeModal();renderLines();alert('Gespeichert!')}function deleteLine(id){if(confirm('Delete?')){lines=lines.filter(l=>l.id!==id);renderLines()}}function editLine(id){openLineModal(id)}function renderStops(){const c=document.getElementById('stopsList');if(!c)return;if(stops.length===0){c.innerHTML='<div class="empty-state">Keine Stops. Klicke auf + um eine zu erstellen.</div>';return}c.innerHTML=stops.map(s=>`<div class="item-card"><div class="item-info"><h3>${s.name} (${s.shortCode})</h3><p><b>ID:</b> ${s.id}</p></div><div class="item-actions"><button onclick="editStop('${s.id}')" class="btn btn-secondary">Edit</button><button onclick="deleteStop('${s.id}')" class="btn btn-secondary">Delete</button></div></div>`).join('')}function openStopModal(id=null){const s=id?stops.find(x=>x.id===id):null;const ao=audioLibrary.filter(a=>a.tags&&(a.tags.includes('stop')||a.tags.includes('via'))).map(a=>`<option value="${a.id}" ${s&&s.audioId===a.id?'selected':''}>${a.id}</option>`).join('');showModal(`<span class="close" onclick="closeModal()">×</span><h2>${s?'Edit':'New'} Stop</h2><label>ID:</label><input id="stopId" value="${s?s.id:''}" ${s?'readonly':''}/><label>Name:</label><input id="stopName" value="${s?s.name:''}"/><label>Code:</label><input id="shortCode" value="${s?s.shortCode:''}"/><label>Type:</label><select id="stopType"><option value="regular" ${s&&s.type==='regular'?'selected':''}>Regular</option><option value="ersatz" ${s&&s.type==='ersatz'?'selected':''}>Ersatz</option></select><label><input type="checkbox" id="isTemporary" ${s&&s.isTemporary?'checked':''}/>Temp</label><label>Audio:</label><select id="stopAudioId"><option value="">--</option>${ao}</select><div class="modal-buttons"><button onclick="closeModal()" class="btn btn-secondary">Cancel</button><button onclick="saveStop(${!!s})" class="btn btn-primary">Save</button></div>`)}function saveStop(isEdit){const id=document.getElementById('stopId').value.trim();if(!id){alert('ID fehlt');return}const data={id,name:document.getElementById('stopName').value.trim(),shortCode:document.getElementById('shortCode').value.trim(),type:document.getElementById('stopType').value,isTemporary:document.getElementById('isTemporary').checked,audioId:document.getElementById('stopAudioId').value,lines:[]};if(isEdit){const idx=stops.findIndex(s=>s.id===id);if(idx!==-1)stops[idx]=data}else{stops.push(data)}closeModal();renderStops();alert('Gespeichert!')}function deleteStop(id){if(confirm('Delete?')){stops=stops.filter(s=>s.id!==id);renderStops()}}function editStop(id){openStopModal(id)}function showModal(html){let m=document.getElementById('modal');if(!m){m=document.createElement('div');m.id='modal';m.className='modal';m.innerHTML='<div class="modal-content"></div>';document.body.appendChild(m)}m.querySelector('.modal-content').innerHTML=html;m.classList.remove('hidden')}function closeModal(){const m=document.getElementById('modal');if(m)m.classList.add('hidden')}function exportData(){if(cycles.length===0&&lines.length===0&&stops.length===0){alert('Keine Daten!');return}downloadJson(JSON.stringify({cycles},null,2),'cycles.json');downloadJson(JSON.stringify({lines},null,2),'lines.json');downloadJson(JSON.stringify({stops},null,2),'stops.json');alert('Exportiert!')}function downloadJson(c,f){const b=new Blob([c],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u)}console.log('Konfigurator loaded');