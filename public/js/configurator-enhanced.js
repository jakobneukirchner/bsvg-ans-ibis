// Konfigurator mit Tooltips + Sonderansagen Templates
const TEMPLATES={connection:[{type:'next_stop',text:'Nächster Halt: {stop}',desc:'Standard Haltestelle'},{type:'via',text:Über {via}»,desc:'Via-Stop'},{type:'terminus',text:'Endstation {stop}',desc:'Endhalt'}],special:[{type:'delay',text:'Verspätung ca. {minutes} Minuten',desc:'Verspätung'},{type:'disruption',text:'Umleitung über {via}',desc:'Umleitung'},{type:'closed',text:'Haltestelle {stop} entfällt',desc:'Ausfall'}],info:[{type:'connection',text:'Anschluss zur Linie {line}',desc:'Umstieg'},{type:'service',text:'Bitte beachten Sie: {info}',desc:'Info'},{type:'thank',text:'Vielen Dank für Ihre Fahrt',desc:'Danke'}]};function tip(text){return`<span class="tooltip" data-tip="${text}">?</span>`}function openCycleModalEnhanced(id=null){const c=id?cycles.find(x=>x.cycleId===id):null;const ao=audioLibrary.filter(a=>a.tags&&a.tags.includes('destination')).map(a=>`<option value="${a.id}" ${c&&c.destinationAudioId===a.id?'selected':''}>${a.id}</option>`).join('');const lo=lines.map(l=>`<option value="${l.id}" ${c&&c.lineId===l.id?'selected':''}>${l.name}</option>`).join('');const ann=c&&c.specialAnnouncements?c.specialAnnouncements:[];showModal(`<span class="close" onclick="closeModal()">×</span><h2>${c?'Umlauf bearbeiten':'Neuer Umlauf'}</h2><label>Umlauf-ID ${tip('Format: Linie_Nummer, z.B. 3_10')}</label><input id="cycleId" value="${c?c.cycleId:''}" ${c?'readonly':''} placeholder="3_10"/><label>Linie ${tip('Wähle die zugehörige Linie aus')}</label><select id="lineId">${lo||'<option>Keine Linien</option>'}</select><label>Typ ${tip('Regelbetrieb oder Umleitung')}</label><select id="type"><option value="regular" ${c&&c.type==='regular'?'selected':''}>Regelbetrieb</option><option value="diversion" ${c&&c.type==='diversion'?'selected':''}>Umleitung</option></select><label>Name ${tip('Anzeigename, z.B. "Linie 3 nach Gliesmarode"')}</label><input id="name" value="${c?c.name:''}" placeholder="Linie 3 nach Gliesmarode"/><label>Richtung ${tip('Ziel/Endhaltestelle')}</label><input id="direction" value="${c?c.direction:''}" placeholder="Gliesmarode"/><label>Destination Audio ${tip('Ansage für Ziel')}</label><select id="destinationAudioId"><option value="">--</option>${ao}</select><label>Via-Stops ${tip('Komma-getrennt: ERS-A, HBF')}</label><input id="viaStops" value="${c&&c.viaStops?c.viaStops.join(','):' '}" placeholder="ERS-A,HBF"/><label>Priority ${tip('1-10, höher = wichtiger')}</label><input type="number" id="priority" value="${c?c.priority:1}" min="1" max="10"/><div class="form-section"><div class="form-section-title">⚠️ Sonderansagen ${tip('Spezielle Durchsagen für diesen Umlauf')}</div><div id="announcementsEditor"></div></div><div class="modal-buttons"><button onclick="closeModal()" class="btn btn-secondary">Abbrechen</button><button onclick="saveCycleEnhanced(${!!c})" class="btn btn-primary">Speichern</button></div>`);renderAnnouncementsEditor(ann)}function renderAnnouncementsEditor(announcements){const editor=document.getElementById('announcementsEditor');if(!editor)return;const groups=Object.keys(TEMPLATES);editor.innerHTML=`<div class="announcements-editor"><div class="announcement-templates">${groups.map(g=>TEMPLATES[g].map(t=>`<button type="button" class="template-btn" onclick="addAnnouncement('${t.type}','${t.text.replace(/'/g,"\\'")}')"><span class="template-btn-title">${t.desc}</span><span class="template-btn-desc">${t.text}</span></button>`).join('')).join('')}</div><div class="announcement-list" id="announcementList">${announcements.length===0?'<div class="empty-announcements">Keine Sonderansagen</div>':announcements.map((a,i)=>`<div class="announcement-item"><div class="announcement-header"><span class="announcement-type">${a.type}</span><button class="announcement-remove" onclick="removeAnnouncement(${i})">×</button></div><div class="announcement-content">${a.text||a.audioId||'-'}</div></div>`).join('')}</div></div>`}let currentAnnouncements=[];function addAnnouncement(type,text){currentAnnouncements.push({type,text,condition:'always'});renderAnnouncementsList()}function removeAnnouncement(idx){currentAnnouncements.splice(idx,1);renderAnnouncementsList()}function renderAnnouncementsList(){const list=document.getElementById('announcementList');if(!list)return;list.innerHTML=currentAnnouncements.length===0?'<div class="empty-announcements">Keine Sonderansagen</div>':currentAnnouncements.map((a,i)=>`<div class="announcement-item"><div class="announcement-header"><span class="announcement-type">${a.type}</span><button class="announcement-remove" onclick="removeAnnouncement(${i})">×</button></div><div class="announcement-content">${a.text}</div></div>`).join('')}function saveCycleEnhanced(isEdit){const id=document.getElementById('cycleId').value.trim();if(!id){alert('ID fehlt');return}const data={cycleId:id,paddedId:id.split('_')[1]?id.split('_')[1].padStart(2,'0'):'01',lineId:document.getElementById('lineId').value,type:document.getElementById('type').value,name:document.getElementById('name').value.trim(),direction:document.getElementById('direction').value.trim(),destinationAudioId:document.getElementById('destinationAudioId').value,viaStops:document.getElementById('viaStops').value.trim().split(',').map(s=>s.trim()).filter(Boolean),route:[],specialAnnouncements:currentAnnouncements,priority:parseInt(document.getElementById('priority').value)||1};if(isEdit){const idx=cycles.findIndex(c=>c.cycleId===id);if(idx!==-1)cycles[idx]=data}else{cycles.push(data)}closeModal();currentAnnouncements=[];renderCycles();alert('Gespeichert!')}window.openCycleModal=openCycleModalEnhanced;window.addAnnouncement=addAnnouncement;window.removeAnnouncement=removeAnnouncement;window.saveCycle=saveCycleEnhanced;console.log('Enhanced Configurator loaded');